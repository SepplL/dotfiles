- name: Bootstrap development environment
  hosts: localhost

  tasks:
    - name: Install packages with dnf
      include_tasks: ./packages/dnf.yml
      when: ansible_facts["distribution"] == "Fedora"

    - name: Install packages with zypper
      include_tasks: ./packages/zypper.yml
      when: ansible_facts["distribution"] == "openSUSE Tumbleweed"

    - name: Install packages with pacman
      include_tasks: ./packages/pacman.yml
      when: ansible_facts["distribution"] == "Archlinux"

    # Retrieved 2025-11-16, License - CC BY-SA 4.0
    - name: Set login shell of user {{ ansible_env['USER'] }} to `/bin/zsh` with `usermod`
      ansible.builtin.command: usermod --shell /bin/zsh {{ ansible_env['USER'] }}
      become: true
      changed_when: false

    - stat:
        path: $HOME/.local/bin/brightnessChanger
      register: statusBR

    - stat:
        path: $HOME/.local/share/fonts/JetBrainsMonoNLNerdFontMono-Medium.ttf
      register: JetBrainsNerdFont

    - stat:
        path: /usr/local/bin/riveroverflow
      register: riveroverflow

    - name: Install JetBrains Mono Nerd Font
      shell: |
        mkdir -p ~/.local/share/fonts && cd ~/.local/share/fonts
        curl -OL https://github.com/ryanoasis/nerd-fonts/releases/latest/download/JetBrainsMono.tar.xz
        tar xvf JetBrainsMono.tar.xz
        cd -
      when: not JetBrainsNerdFont.stat.exists

    - name: Include building Brightness Changer from custom to ~/.local
      # include_tasks: ./custom/brightnessChanger/build.yml
      shell: |
        cd custom/brightnessChanger
        zig build install -Doptimize=ReleaseFast -p ~/.local
        cd -
      when: not statusBR.stat.exists

    - name: Build and install riveroverflow
      shell: |
        cd custom/riveroverflow
        make
        sudo make install
        cd -
      when: not riveroverflow.stat.exists

    - name: Run Stow  # to manage the dotfiles
      shell: "stow --target={{ ansible_env['HOME'] }} .dotfiles --verbose=2"
      register: result
      changed_when: 'result.stderr is search("LINK: ")'
